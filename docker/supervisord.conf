; -----------------------------------------------------------------------------
; Supervisor Process Orchestration
; -----------------------------------------------------------------------------
; Role: PID 1 (Container Entrypoint)
;
; Architecture Note (Hybrid Privilege Model):
; To resolve common Docker permission issues with logging streams and PID files,
; we employ a hybrid approach:
; 1. Supervisor runs as ROOT to maintain control over system paths (/var/log, /var/run).
; 2. Child processes (PHP) run as SAIL (unprivileged) to ensure application security.
; -----------------------------------------------------------------------------

[supervisord]

; -----------------------------------------------------------------------------
; Core Process Settings
; -----------------------------------------------------------------------------

; Run in the foreground.
; Docker containers exit when the main process (PID 1) backgrounds itself.
nodaemon=true

; User Context:
; We execute Supervisor as ROOT. This is necessary to allow it to open
; /dev/stdout and /dev/stderr system streams and pass them to child processes.
user=root

; -----------------------------------------------------------------------------
; Logging & State
; -----------------------------------------------------------------------------

; Internal Supervisor Logs:
; Captures process spawn/exit events.
logfile=/var/log/supervisor/supervisord.log

; PID File Location:
; Since Supervisor runs as root, we can use the standard system location.
pidfile=/var/run/supervisord.pid

; -----------------------------------------------------------------------------
; Application: PHP / Laravel
; -----------------------------------------------------------------------------
[program:php]

; Command Injection:
; The command is injected via the Dockerfile ENV. This allows flexibility to
; switch between 'php artisan serve', 'php-fpm', or 'octane' without code changes.
command=%(ENV_SUPERVISOR_PHP_COMMAND)s

; Security (Privilege Dropping):
; CRITICAL: Although Supervisor is root, the actual web application MUST run
; as the unprivileged user ('sail') to mitigate the impact of potential RCE vulnerabilities.
user=%(ENV_SUPERVISOR_PHP_USER)s

; Environment:
; Ensure Laravel detects it is running within a Sail/Docker environment.
environment=LARAVEL_SAIL="1"

; -----------------------------------------------------------------------------
; 12-Factor App Logging (Stream Redirection)
; -----------------------------------------------------------------------------
; We redirect application output (stdout) and errors (stderr) to the special
; device files so Docker can capture and manage logs (e.g., via 'docker logs').
;
; NOTE: maxbytes=0 is MANDATORY. Supervisor's built-in log rotation fails
; when writing to device streams, causing the process to crash or logs to halt.

stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

; -----------------------------------------------------------------------------
; Lifecycle & Signal Propagation
; -----------------------------------------------------------------------------

; Restart Policy:
; Automatically restart PHP if it crashes (segfault or error).
autorestart=true

; Signal Handling:
; Ensure signals (like SIGTERM from 'docker stop') are sent to the entire
; process group. This prevents "zombie" processes when using wrappers.
stopasgroup=true
killasgroup=true
